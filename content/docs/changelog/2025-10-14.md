---
title: "14 Ekim 2025 - Sınıf Yönetimi İyileştirmeleri"
weight: 6
---

# 14 Ekim 2025 - Sınıf Yönetimi İyileştirmeleri

# Genel Bakış
Bugün sınıf (class) sekmesindeki kritik hataları düzelttik ve öğrenci-öğretmen görünümlerini iyileştirdik. Supabase RLS (Row Level Security) politikalarından kaynaklanan veri erişim sorunlarını RPC fonksiyonları ile çözdük.

---

# Düzeltilen Hatalar

###  1. Öğrenci "Sınıfa Katıl" Butonu Kayboluyor
**Problem:** Öğrenci bir sınıfa katıldıktan sonra FloatingActionButton kayboluyordu, bu yüzden birden fazla sınıfa katılamıyordu.

**Çözüm:** FAB görünürlük koşulunu değiştirdik.

###  2. Sınıf Detaylarında Statik Veri Gösteriliyor
**Problem:** Öğrenci bir sınıfa tıkladığında gerçek veritabanı verileri yerine sahte (mock) bilgiler gösteriliyordu.

**Çözüm:** Veritabanından gerçek veri çeken servis metodları ekledik.

###  3. RLS Policy Sonsuz Döngü Hatası
**Problem:** `classes` ve `class_members` tabloları arasında circular dependency (döngüsel bağımlılık) oluşuyordu.

**Çözüm:** RLS'yi bypass eden `SECURITY DEFINER` fonksiyonları kullandık.

###  4. Öğrenci Listesi Görünmüyor
**Problem:** Öğrenci sayısı doğru görünüyordu (4) ama öğrenci listesi boş geliyordu.

**Çözüm:** Öğrenci listesini de RPC fonksiyonu ile çekecek şekilde güncelledik.

---

# Değiştirilen Dosyalar

###  1. `lib/presentation/screens/student_class_list_screen.dart`
**Değişiklik:** FloatingActionButton her zaman görünür olacak şekilde düzenlendi.

**Detaylar:**
- `MainLayout` widget'ına yeni parametreler eklendi:
  - `showFab: !_isLoading` → Yalnızca yükleme sırasında gizle
  - `onFabPressed: () => _showJoinClassDialog()`
  - `fabIcon: Icons.add`
  - `fabLabel: 'Sınıfa Katıl'`

**Etki:** Öğrenciler artık birden fazla sınıfa katılabilir.

---

###  2. `lib/presentation/widgets/main_layout.dart`
**Değişiklik:** FAB (Floating Action Button) özelleştirilebilir hale getirildi.

**Detaylar:**
- Yeni parametreler eklendi:
  ```dart
  final IconData? fabIcon;
  final String? fabLabel;
  ```
- FAB tipi değişti:
  - Etiket varsa → `FloatingActionButton.extended()` (icon + text)
  - Etiket yoksa → `FloatingActionButton()` (sadece icon)

**Etki:** Tüm ekranlarda esnek FAB kullanımı sağlandı.

---

###  3. `lib/services/class_member_service.dart`
**Değişiklik:** Yeni metodlar eklendi ve RLS bypass için RPC kullanımına geçildi.

####  Eklenen Metodlar:

**a) `getClassStudentCount(int classId)`**
- Supabase RPC fonksiyonu çağırır: `get_class_student_count`
- Bir sınıftaki toplam öğrenci sayısını döndürür
- RLS bypass edilir (`SECURITY DEFINER`)

**b) `getClassDetails(int classId)` [GÜNCELLENDİ]**
- İlk hali: Doğrudan `class_members` tablosundan JOIN ile sorgu yapıyordu
- **Son hali:** RPC fonksiyonu kullanıyor
  - Sınıf bilgileri: Normal sorgu ile çekilir
  - Öğrenci listesi: `get_class_students` RPC fonksiyonu ile çekilir
- Döndürdüğü veri:
  ```dart
  {
    'class_name': '...',
    'teacher_name': '...',
    'class_code': '...',
    'students': [...]
  }
  ```

**Etki:** RLS politikalarına takılmadan veri çekilebiliyor.

---

###  4. `lib/presentation/widgets/class_card.dart`
**Değişiklik:** Öğrenci sayısı desteği eklendi.

**Detaylar:**
- Yeni parametre: `int? studentCount`
- Mantık:
  - `studentCount` verilmişse → RPC'den gelen sayıyı göster
  - Verilmemişse → `classData.studentCountText` kullan (eski davranış)

**Etki:** Geriye uyumlu (backward compatible) şekilde güncelleme yapıldı.

---

###  5. `lib/presentation/screens/class_detail_screen.dart`
**Değişiklik:** Öğretmen görünümü için "Classmates" → "Students" değişti ve gerçek veri gösterimi eklendi.

**Detaylar:**

**a) State değişkenleri:**
- `int _studentCount = 0;` eklendi

**b) `_loadClassDetails()` metodu güncellendi:**
- İki ayrı servis çağrısı yapılır:
  1. `getClassStudentCount()` → Sayı için
  2. `getClassDetails()` → Detaylı bilgi ve öğrenci listesi için
- Veritabanından gelen veriler state'e atanır

**c) Metod isimleri değişti:**
- `_buildClassmatesTab()` → `_buildStudentsTab()`
- Tab başlığı: "Classmates" → "Students"

**d) Tab içeriği:**
- Öğrenci listesi artık boş değil, gerçek veriler gösteriliyor
- Her öğrenci için avatar, isim, okul numarası ve katılma tarihi gösteriliyor

**Etki:** Öğretmenler sınıfa kayıtlı tüm öğrencileri görebilir.

---

##  ️ Supabase Değişiklikleri

###  RPC Fonksiyonları Oluşturuldu:

####  1. `get_class_student_count(p_class_id int)`
```sql
CREATE OR REPLACE FUNCTION get_class_student_count(p_class_id int)
RETURNS int
LANGUAGE plpgsql
SECURITY DEFINER
```
- Bir sınıftaki aktif öğrenci sayısını döndürür
- `deleted_at IS NULL` kontrolü yapar

####  2. `get_class_students(p_class_id int)`
```sql
CREATE OR REPLACE FUNCTION get_class_students(p_class_id int)
RETURNS TABLE(id int, name varchar, email varchar, school_number varchar, joined_at timestamptz)
LANGUAGE plpgsql
SECURITY DEFINER
```
- Bir sınıftaki tüm öğrencileri detaylı şekilde döndürür
- `class_members` ve `users` tabloları JOIN edilir
- Katılma tarihine göre sıralanır (ASC)

**Önemli:** Her iki fonksiyon da `SECURITY DEFINER` ile tanımlandı, böylece RLS politikalarını bypass ederler.

---

# Test Edilenler

1. ✅ Öğrenci birden fazla sınıfa katılabiliyor
2. ✅ FloatingActionButton sürekli görünür
3. ✅ Sınıf detaylarında gerçek öğretmen ismi gösteriliyor
4. ✅ Sınıf kodu doğru görünüyor
5. ✅ Öğrenci sayısı doğru (4 öğrenci)
6. ✅ Öğrenci listesi tam olarak gösteriliyor
7. ✅ "Students" tab başlığı öğretmen görünümünde aktif

---

# Teknik Notlar

###  RLS vs RPC Yaklaşımı
- **Sorun:** Supabase RLS politikaları bazen circular dependency oluşturur
- **Çözüm:** Kritik sorgular için `SECURITY DEFINER` RPC fonksiyonları kullandık
- **Avantaj:** RLS bypass edilerek performans ve güvenilirlik artırıldı
- **Dezavantaj:** Her yeni sorgu için fonksiyon yazmak gerekebilir

###  Backward Compatibility
- `ClassCard` widget'ı eski kullanıma da uyumlu
- `studentCount` parametresi opsiyonel
- Eski kodlar çalışmaya devam eder

###  Kod Kalitesi
- Dart lint uyarıları (unnecessary cast) göz ardı edildi
- Fonksiyonel olarak sorun yok
- İleride temizlenebilir

---

# Etkilenen Tablolar

| Tablo | İşlem | Açıklama |
|-------|-------|----------|
| `classes` | SELECT | Sınıf bilgileri çekildi |
| `class_members` | SELECT | RPC ile öğrenci verileri alındı |
| `users` | SELECT (JOIN) | Öğrenci detayları çekildi |
| `roles` | - | Kullanılmadı |

---

# Sonraki Adımlar (Öneriler)

1. **Performans:** RPC fonksiyonlarına index eklenebilir
2. **Güvenlik:** RPC fonksiyonlarına yetki kontrolleri eklenebilir
3. **Cache:** Öğrenci listesi cache'lenebilir
4. **UI:** Loading states iyileştirilebilir
5. **Error Handling:** Daha detaylı hata mesajları gösterilebilir

---

# Etkilenen Kullanıcı Rolleri

- **Öğrenci:** Sınıfa katılma ve detayları görme
- **Öğretmen:** Sınıftaki öğrencileri görüntüleme
- **Admin:** (Değişiklik yok)

---

**Hazırlayan:** GitHub Copilot  
**Tarih:** 14 Ekim 2025  
**Versiyon:** 1.0.0
